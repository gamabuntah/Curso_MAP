<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - PNSB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div class="admin-container">
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fa-solid fa-arrow-left"></i> Voltar ao Curso
        </button>

        <div class="admin-header">
            <h1><i class="fa-solid fa-user-shield"></i> Painel Administrativo</h1>
            <p>Gerencie usuários, progresso e certificados do curso PNSB</p>
        </div>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="showTab('overview')">Visão Geral</button>
            <button class="tab-btn" onclick="showTab('users')">Usuários</button>
            <button class="tab-btn" onclick="showTab('certificates')">Certificados</button>
        </div>

        <!-- Tab: Visão Geral -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total de Usuários</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">-</div>
                    <div class="stat-label">Usuários Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCertificates">-</div>
                    <div class="stat-label">Certificados Emitidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgProgress">-</div>
                    <div class="stat-label">Progresso Médio</div>
                </div>
            </div>
        </div>

        <!-- Tab: Usuários -->
        <div id="users" class="tab-content">
            <h3>Progresso dos Usuários</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Progresso</th>
                            <th>Módulos Concluídos</th>
                            <th>Avaliação Final</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center;">Carregando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Certificados -->
        <div id="certificates" class="tab-content">
            <h3>Certificados Emitidos</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Código</th>
                            <th>Data de Emissão</th>
                            <th>Pontuação</th>
                            <th>Downloads</th>
                            <th>Validações</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="certificatesTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center;">Carregando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Detecta automaticamente se está em produção ou desenvolvimento
        const baseURL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
        
        // Verificação de admin
        const currentUser = sessionStorage.getItem('currentUser');
        const userRole = sessionStorage.getItem('userRole');
        
        if (!currentUser || userRole !== 'admin') {
            alert('Acesso negado. Apenas administradores podem acessar este painel.');
            window.location.href = 'login.html';
        }

        function showTab(tabName) {
            // Remove active de todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Adiciona active na tab selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Carrega dados específicos da tab
            if (tabName === 'users') {
                loadUsersData();
            } else if (tabName === 'certificates') {
                loadCertificatesData();
            } else if (tabName === 'overview') {
                loadOverviewData();
            }
        }

        async function loadOverviewData() {
            try {
                // Carrega dados de usuários
                const usersResponse = await fetch(`${baseURL}/api/admin/all-progress?adminUser=${currentUser}`);
                const usersData = await usersResponse.json();

                // Carrega dados de certificados
                const certsResponse = await fetch(`${baseURL}/api/admin/all-certificates?adminUser=${currentUser}`);
                const certsData = await certsResponse.json();

                // Atualiza estatísticas
                document.getElementById('totalUsers').textContent = usersData.length || 0;
                document.getElementById('activeUsers').textContent = usersData.filter(u => u.progressPercent > 0).length || 0;
                document.getElementById('totalCertificates').textContent = certsData.length || 0;
                
                const avgProgress = usersData.length > 0 
                    ? Math.round(usersData.reduce((sum, u) => sum + u.progressPercent, 0) / usersData.length)
                    : 0;
                document.getElementById('avgProgress').textContent = avgProgress + '%';

            } catch (error) {
                console.error('Erro ao carregar dados gerais:', error);
                // Valores padrão em caso de erro
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('activeUsers').textContent = '0';
                document.getElementById('totalCertificates').textContent = '0';
                document.getElementById('avgProgress').textContent = '0%';
            }
        }

        async function loadUsersData() {
            try {
                const response = await fetch(`${baseURL}/api/admin/all-progress?adminUser=${currentUser}`);
                const usersData = await response.json();

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                if (usersData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum usuário encontrado</td></tr>';
                    return;
                }

                usersData.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${user.username}</strong></td>
                        <td>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${user.progressPercent}%;"></div>
                                <span class="progress-text">${user.progressPercent}%</span>
                            </div>
                        </td>
                        <td>${user.completedModules}/8</td>
                        <td>${user.finalEvaluationScore !== 'N/A' ? user.finalEvaluationScore + '%' : 'Não realizada'}</td>
                        <td>
                            <span class="status-badge ${user.progressPercent === 100 ? 'status-completed' : user.progressPercent > 0 ? 'status-available' : 'status-locked'}">
                                ${user.progressPercent === 100 ? 'Concluído' : user.progressPercent > 0 ? 'Em Progresso' : 'Não Iniciado'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" onclick="viewUserProgress('${user.username}')">
                                <i class="fa-solid fa-eye"></i> Ver
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Erro ao carregar dados de usuários:', error);
                document.getElementById('usersTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: red;">Erro ao carregar dados</td></tr>';
            }
        }

        async function loadCertificatesData() {
            try {
                const response = await fetch(`${baseURL}/api/admin/all-certificates?adminUser=${currentUser}`);
                const certsData = await response.json();

                const tbody = document.getElementById('certificatesTableBody');
                tbody.innerHTML = '';

                if (certsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhum certificado encontrado</td></tr>';
                    return;
                }

                certsData.forEach(cert => {
                    const issuedDate = new Date(cert.issuedDate).toLocaleDateString('pt-BR');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${cert.username}</strong></td>
                        <td><code>${cert.validationCode}</code></td>
                        <td>${issuedDate}</td>
                        <td>${cert.finalScore}%</td>
                        <td>${cert.downloadCount || 0}</td>
                        <td>${cert.validationCount || 0}</td>
                        <td>
                            <span class="status-badge ${cert.status === 'issued' ? 'status-completed' : 'status-locked'}">
                                ${cert.status === 'issued' ? 'Emitido' : 'Revogado'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" onclick="validateCertificate('${cert.validationCode}')">
                                <i class="fa-solid fa-search"></i> Validar
                            </button>
                            <button class="action-btn danger" onclick="revokeCertificate('${cert.username}')">
                                <i class="fa-solid fa-ban"></i> Revogar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Erro ao carregar dados de certificados:', error);
                document.getElementById('certificatesTableBody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: red;">Erro ao carregar dados</td></tr>';
            }
        }

        async function viewUserProgress(username) {
            try {
                const response = await fetch(`${baseURL}/api/progress/${username}`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar progresso do usuário');
                }
                
                const progress = await response.json();
                showUserProgressModal(username, progress);
            } catch (error) {
                console.error('Erro ao carregar progresso:', error);
                alert(`Erro ao carregar progresso de ${username}: ${error.message}`);
            }
        }

        function showUserProgressModal(username, progress) {
            // Remove modal anterior se existir
            const existingModal = document.getElementById('userProgressModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Calcular estatísticas
            const modules = progress.modules || {};
            const totalModules = 8;
            const completedModules = Object.values(modules).filter(m => m.status === 'completed').length;
            const failedModules = Object.values(modules).filter(m => m.status === 'failed').length;
            const progressPercent = Math.round((completedModules / totalModules) * 100);

            // Criar modal
            const modal = document.createElement('div');
            modal.id = 'userProgressModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            // Criar módulos HTML
            let modulesHTML = '';
            for (let i = 1; i <= totalModules; i++) {
                const moduleData = modules[i.toString()] || { status: 'locked', score: null, audioCompleted: false };
                const statusIcon = {
                    'completed': '✅',
                    'failed': '❌',
                    'available': '📖',
                    'locked': '🔒'
                }[moduleData.status] || '🔒';
                
                const scoreText = moduleData.score !== null ? `${moduleData.score}%` : 'N/A';
                const audioStatus = moduleData.audioCompleted ? '🎵' : '🔇';
                
                modulesHTML += `
                    <tr>
                        <td>Módulo ${i}</td>
                        <td>${statusIcon} ${moduleData.status}</td>
                        <td>${scoreText}</td>
                        <td>${audioStatus}</td>
                    </tr>
                `;
            }

            // Avaliação final
            const finalEval = progress.final_evaluation || {};
            const finalStatus = finalEval.status || 'not_attempted';
            const finalScore = finalEval.score || 'N/A';

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Progresso de ${username}</h2>
                        <button onclick="document.getElementById('userProgressModal').remove()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">×</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #3498db; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3>${progressPercent}%</h3>
                            <p>Progresso Geral</p>
                        </div>
                        <div style="background: #27ae60; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3>${completedModules}/${totalModules}</h3>
                            <p>Módulos Concluídos</p>
                        </div>
                        <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3>${failedModules}</h3>
                            <p>Módulos Falharam</p>
                        </div>
                        <div style="background: #f39c12; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3>${finalScore}%</h3>
                            <p>Avaliação Final</p>
                        </div>
                    </div>

                    <h3>Detalhes dos Módulos</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #ddd;">Módulo</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Pontuação</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Áudio</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${modulesHTML}
                        </tbody>
                    </table>

                    <h3>Avaliação Final</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Status:</strong> ${finalStatus}</p>
                        <p><strong>Pontuação:</strong> ${finalScore}${typeof finalScore === 'number' ? '%' : ''}</p>
                        <p><strong>Data:</strong> ${finalEval.date ? new Date(finalEval.date).toLocaleDateString('pt-BR') : 'N/A'}</p>
                    </div>

                    <div style="text-align: right;">
                        <button onclick="document.getElementById('userProgressModal').remove()" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Fechar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Fechar modal ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function validateCertificate(validationCode) {
            window.open(`validate.html?code=${validationCode}`, '_blank');
        }

        async function revokeCertificate(username) {
            if (!confirm(`Tem certeza que deseja revogar o certificado de ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`${baseURL}/api/certificates/${username}/revoke?adminUser=${currentUser}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'Revogado pelo administrador' })
                });

                if (response.ok) {
                    alert('Certificado revogado com sucesso!');
                    loadCertificatesData(); // Recarrega a tabela
                } else {
                    alert('Erro ao revogar certificado.');
                }
            } catch (error) {
                console.error('Erro ao revogar certificado:', error);
                alert('Erro ao revogar certificados.');
            }
        }

        // Carrega dados iniciais quando a página carrega
        window.addEventListener('load', () => {
            loadOverviewData();
        });
    </script>
</body>
</html> 