<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Curso PNSB</title>
    <link rel="stylesheet" href="admin.css?v=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="header-left">
                <button class="back-btn" onclick="goBackToSystem()" title="Voltar ao Sistema">
                    <i class="fa-solid fa-arrow-left"></i> Voltar ao Curso
                </button>
                <h1><i class="fa-solid fa-shield-halved"></i> Painel Administrativo</h1>
            </div>
            <div class="admin-info">
                <span>Bem-vindo, <strong id="adminName">Admin</strong></span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fa-solid fa-right-from-bracket"></i> Sair
                </button>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="showTab('overview')">Visão Geral</button>
            <button class="tab-btn" onclick="showTab('users')">Usuários</button>
            <button class="tab-btn" onclick="showTab('certificates')">Certificados</button>
        </div>

        <!-- Tab: Visão Geral -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total de Usuários</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">-</div>
                    <div class="stat-label">Usuários Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCertificates">-</div>
                    <div class="stat-label">Certificados Emitidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgProgress">-</div>
                    <div class="stat-label">Progresso Médio</div>
                </div>
            </div>
        </div>

        <!-- Tab: Usuários -->
        <div id="users" class="tab-content">
            <h3>Progresso dos Usuários</h3>
            <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Progresso</th>
                        <th>Módulos Concluídos</th>
                        <th>Avaliação Final</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center;">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
            </div>
        </div>

        <!-- Tab: Certificados -->
        <div id="certificates" class="tab-content">
            <h3>Certificados Emitidos</h3>
            <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Código</th>
                        <th>Data de Emissão</th>
                        <th>Pontuação</th>
                        <th>Downloads</th>
                        <th>Validações</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="certificatesTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center;">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <script>
        // Detecta automaticamente se está em produção ou desenvolvimento
        const baseURL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
        
        // Verificação de admin
        const currentUser = sessionStorage.getItem('currentUser');
        const userRole = sessionStorage.getItem('userRole');
        
        if (!currentUser || userRole !== 'admin') {
            alert('Acesso negado. Apenas administradores podem acessar este painel.');
            window.location.href = 'login.html';
        }

        // Atualizar nome do admin
        document.getElementById('adminName').textContent = currentUser;

        // Função para mostrar abas
        function showTab(tabName) {
            // Remove classe active de todas as abas e botões
            document.querySelectorAll('.tab-content').forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });

            // Adiciona classe active na aba e botão selecionados
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Carrega dados específicos da aba
            if (tabName === 'users') {
                loadUsersData();
            } else if (tabName === 'certificates') {
                loadCertificatesData();
            } else if (tabName === 'overview') {
                loadOverviewData();
            }
        }

        // Função para voltar ao sistema principal
        function goBackToSystem() {
            window.location.href = 'index.html';
        }

        // Função para logout
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // Carrega dados da visão geral
        async function loadOverviewData() {
            try {
                // Carrega dados de usuários
                const usersResponse = await fetch(baseURL + '/api/admin/all-progress?adminUser=' + currentUser);
                const usersData = await usersResponse.json();

                // Carrega dados de certificados
                const certsResponse = await fetch(baseURL + '/api/admin/all-certificates?adminUser=' + currentUser);
                const certsData = await certsResponse.json();

                // Atualiza estatísticas
                document.getElementById('totalUsers').textContent = usersData.length || 0;
                document.getElementById('activeUsers').textContent = usersData.filter(function(u) { return u.progressPercent > 0; }).length || 0;
                document.getElementById('totalCertificates').textContent = certsData.length || 0;
                
                const avgProgress = usersData.length > 0 
                    ? Math.round(usersData.reduce(function(sum, u) { return sum + (u.progressPercent || 0); }, 0) / usersData.length)
                    : 0;
                document.getElementById('avgProgress').textContent = avgProgress + '%';

            } catch (error) {
                console.error('Erro ao carregar dados gerais:', error);
                // Valores padrão em caso de erro
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('activeUsers').textContent = '0';
                document.getElementById('totalCertificates').textContent = '0';
                document.getElementById('avgProgress').textContent = '0%';
            }
        }

        // Carrega dados dos usuários
        async function loadUsersData() {
            try {
                const response = await fetch(baseURL + '/api/admin/all-progress?adminUser=' + currentUser);
                const usersData = await response.json();

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                if (usersData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum usuário encontrado</td></tr>';
                    return;
                }

                usersData.forEach(function(user) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${user.username}</strong></td>
                        <td>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${user.progressPercent || 0}%;"></div>
                                <span class="progress-text">${user.progressPercent || 0}%</span>
                            </div>
                        </td>
                        <td>${user.completedModules || 0}/8</td>
                        <td>${user.finalEvaluationScore !== 'N/A' ? user.finalEvaluationScore + '%' : 'Não realizada'}</td>
                        <td>
                            <span class="status-badge ${(user.progressPercent || 0) === 100 ? 'status-completed' : (user.progressPercent || 0) > 0 ? 'status-available' : 'status-locked'}">
                                ${(user.progressPercent || 0) === 100 ? 'Concluído' : (user.progressPercent || 0) > 0 ? 'Em Progresso' : 'Não Iniciado'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" onclick="viewUserProgress('${user.username}')">
                                <i class="fa-solid fa-eye"></i> Ver
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Erro ao carregar dados de usuários:', error);
                document.getElementById('usersTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: red;">Erro ao carregar dados</td></tr>';
            }
        }

        // Carrega dados dos certificados
        async function loadCertificatesData() {
            try {
                const response = await fetch(baseURL + '/api/admin/all-certificates?adminUser=' + currentUser);
                const certsData = await response.json();

                const tbody = document.getElementById('certificatesTableBody');
                tbody.innerHTML = '';

                if (certsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhum certificado encontrado</td></tr>';
                    return;
                }

                certsData.forEach(function(cert) {
                    const issuedDate = new Date(cert.issuedDate).toLocaleDateString('pt-BR');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${cert.username}</strong></td>
                        <td><code>${cert.validationCode}</code></td>
                        <td>${issuedDate}</td>
                        <td>${cert.finalScore || 0}%</td>
                        <td>${cert.downloadCount || 0}</td>
                        <td>${cert.validationCount || 0}</td>
                        <td>
                            <span class="status-badge ${cert.status === 'issued' ? 'status-completed' : 'status-locked'}">
                                ${cert.status === 'issued' ? 'Emitido' : 'Revogado'}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn" onclick="validateCertificate('${cert.validationCode}')">
                                <i class="fa-solid fa-search"></i> Validar
                            </button>
                            <button class="action-btn success" onclick="downloadCertificateAsAdmin('${cert.validationCode}')">
                                <i class="fa-solid fa-download"></i> Baixar
                            </button>
                            ${cert.status === 'issued' ? `
                            <button class="action-btn danger" onclick="revokeCertificate('${cert.username}')">
                                    <i class="fa-solid fa-ban"></i> Revogar
                            </button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Erro ao carregar dados de certificados:', error);
                document.getElementById('certificatesTableBody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: red;">Erro ao carregar dados</td></tr>';
            }
        }

        // Visualizar progresso detalhado do usuário
        async function viewUserProgress(username) {
            try {
                const response = await fetch(baseURL + '/api/progress/' + username);
                if (!response.ok) {
                    throw new Error('Erro ao carregar progresso do usuário');
                }
                
                const progress = await response.json();
                showUserProgressModal(username, progress);
            } catch (error) {
                console.error('Erro ao carregar progresso:', error);
                alert('Erro ao carregar progresso de ' + username + ': ' + error.message);
            }
        }

        // Modal de progresso detalhado
        function showUserProgressModal(username, progress) {
            // Remove modal anterior se existir
            const existingModal = document.getElementById('userProgressModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Calcular estatísticas
            const modules = progress.modules || {};
            const totalModules = 8;
            const completedModules = Object.values(modules).filter(function(m) { return m.status === 'completed'; }).length;
            const failedModules = Object.values(modules).filter(function(m) { return m.status === 'failed'; }).length;
            const progressPercent = Math.round((completedModules / totalModules) * 100);

            // Criar modal
            const modal = document.createElement('div');
            modal.id = 'userProgressModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            let modulesHtml = '';
            for (let i = 1; i <= 8; i++) {
                const module = modules['module' + i] || {};
                const status = module.status || 'not_started';
                const score = module.score || 0;
                
                let statusText = 'Não Iniciado';
                let statusClass = 'status-locked';
                
                if (status === 'completed') {
                    statusText = 'Concluído';
                    statusClass = 'status-completed';
                } else if (status === 'failed') {
                    statusText = 'Reprovado';
                    statusClass = 'status-locked';
                } else if (status === 'in_progress') {
                    statusText = 'Em Progresso';
                    statusClass = 'status-available';
                }

                modulesHtml += `
                    <tr>
                        <td>Módulo ${i}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${score}%</td>
                    </tr>
                `;
            }

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Progresso Detalhado - ${username}</h2>
                        <button onclick="document.getElementById('userProgressModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #2980b9;">${progressPercent}%</div>
                            <div style="font-size: 14px; color: #666;">Progresso Geral</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${completedModules}</div>
                            <div style="font-size: 14px; color: #666;">Módulos Concluídos</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${failedModules}</div>
                            <div style="font-size: 14px; color: #666;">Módulos Reprovados</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${progress.final_evaluation ? progress.final_evaluation.score : 'N/A'}</div>
                            <div style="font-size: 14px; color: #666;">Avaliação Final</div>
                        </div>
                    </div>

                    <h3>Detalhes por Módulo</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Módulo</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Status</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Pontuação</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${modulesHtml}
                        </tbody>
                    </table>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Validar certificado
        async function validateCertificate(validationCode) {
            try {
                const response = await fetch(baseURL + '/api/certificates/validate/' + validationCode);
                const result = await response.json();

                if (result.valid) {
                    alert('Certificado VÁLIDO!\n\nUsuário: ' + result.certificate.username + '\nData de Emissão: ' + new Date(result.certificate.issuedDate).toLocaleDateString('pt-BR') + '\nPontuação: ' + result.certificate.finalScore + '%\nValidações: ' + result.certificate.validationCount);
                } else {
                    alert('Certificado INVÁLIDO!\n\nMotivo: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao validar certificado:', error);
                alert('Erro ao validar certificado. Tente novamente.');
            }
        }

        // Revogar certificado
        async function revokeCertificate(username) {
            const reason = prompt('Motivo da revogação do certificado de ' + username + ':');
            if (!reason) return;

            if (!confirm('Tem certeza que deseja revogar o certificado de ' + username + '?\n\nMotivo: ' + reason + '\n\nEsta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const response = await fetch(baseURL + '/api/certificates/' + username + '/revoke?adminUser=' + currentUser, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Certificado revogado com sucesso!');
                    loadCertificatesData(); // Recarrega a lista
                } else {
                    alert('Erro ao revogar certificado: ' + result.message);
                }
            } catch (error) {
                console.error('Erro ao revogar certificado:', error);
                alert('Erro ao revogar certificado. Tente novamente.');
            }
        }

        // Baixar certificado como administrador
        async function downloadCertificateAsAdmin(validationCode) {
            try {
                const response = await fetch(baseURL + '/api/certificates/admin/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ validationCode: validationCode })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao baixar certificado');
                }

                const result = await response.json();
                
                // Simula o download do PDF (aqui você implementaria a lógica de geração de PDF)
                alert('Download do certificado de ' + result.certificate.username + ' iniciado!');
                
                // Incrementa o contador de downloads
                loadCertificatesData(); // Recarrega a lista para mostrar contador atualizado
                
            } catch (error) {
                console.error('Erro ao baixar certificado:', error);
                alert('Erro ao baixar certificado: ' + error.message);
            }
        }

        // Carrega dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
        });
    </script>
</body>
</html> 
